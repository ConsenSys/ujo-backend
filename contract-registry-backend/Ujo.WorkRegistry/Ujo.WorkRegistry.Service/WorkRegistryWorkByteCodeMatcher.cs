using System.Threading.Tasks;
using Nethereum.Web3;

namespace Ujo.WorkRegistry.Service
{
    public class WorkRegistryWorkByteCodeMatcher
    {
        private static string workByteCode =
            "0x6060604052610350806100126000396000f360606040526000357c0100000000000000000000000000000000000000000000000000000000900480636057361d1461004457806386ad3bb6146100c857610042565b005b61005a600480803590602001909190505061029d565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156100ba5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101256004808035906020019091908035906020019082018035906020019191908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505090909190505061013b565b6040518082815260200191505060405180910390f35b600081600060005060008581526020019081526020016000206000509080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106101a057805160ff19168380011785556101d1565b828001600101855582156101d1579182015b828111156101d05782518260005055916020019190600101906101b2565b5b5090506101fc91906101de565b808211156101f857600081815060009055506001016101de565b5090565b5050827f5e3e2854092d716242b4ecf6476ab6875ca5e6fa55512ac82a168128ff712a908360405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600f02600301f150905090810190601f1680156102815780820380516001836020036101000a031916815260200191505b509250505060405180910390a260019050610297565b92915050565b60006000506020528060005260406000206000915090508054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103485780601f1061031d57610100808354040283529160200191610348565b820191906000526020600020905b81548152906001019060200180831161032b57829003601f168201915b50505050508156";
        private readonly Web3 web3;

        public WorkRegistryWorkByteCodeMatcher(Web3 web3)
        {
            this.web3 = web3;
        }

        public async Task<bool> IsMatchAsync(string address)
        {
            var code = await web3.Eth.GetCode.SendRequestAsync(address);
            return EnsureHex(code) == EnsureHex(workByteCode);
        }

        private string EnsureHex(string x)
        {
            if (!x.StartsWith("0x"))
            {
                return "0x" + x;
            }
            return x;
        }
    }
}