using System.Threading.Tasks;
using Nethereum.Hex.HexConvertors.Extensions;
using Nethereum.Web3;

namespace Ujo.WorkRegistry.Service
{
    public class WorkRegistryWorkByteCodeMatcher
    {
        //NOTE: THE HEADER IS REMOVED from the deployment code 0x0x6060604052604051602080610a73833950
        private static string workByteCode =
            "0x606060405236156100775760e060020a6000350463149cc21081146100795780631babd036146100cd57806334cae885146100f75780633cebb823146101a357806363bb4c52146101b1578063654cf88c146101c2578063a33e647e1461022b578063eab700db14610239578063ecdc58c81461024a575b005b61029e60043560008181526003602052604080519082208054909190819083906002600182161561010002600019019091160480156103405780601f1061031e576101008083540402835291820191610340565b6100776004356103535b6000805433600160a060020a039081169116141561095e57506001610962565b604080516004803580820135602081810280860182019096528185526100779593946024949093850192918291908501908490808284375050604080516020601f8935808c01359182018390048302840183019094528083529799986044989297509290920194509250829150840183828082843750949650509335935050505060408051808201825260008082526020828101829052835190810190935280835290916103ad6100d7565b61007760043561058d6100d7565b6100776004356024356105b66100d7565b6102b06004356003602090815260009182526040805192819020805460026001821615610100026000190190911604601f8101849004840285018401909252818452918301828280156106485780601f1061061d57610100808354040283529160200191610648565b6100776004356106506100d7565b6100776004356024356106a66100d7565b60408051602060046024803582810135601f8101859004850286018501909652858552610077958335959394604494939290920191819084018382808284375094965050933593505050505b6106fc6100d7565b60408051918252519081900360200190f35b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156103105780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b820191906000526020600020905b81548152906001019060200180831161032c575b5050604051908190039020949350505050565b156103a85780600160a060020a0316634420e486306040518260e060020a0281526004018082600160a060020a031681526020019150506000604051808303816000876161da5a03f115610002575050505b50565b610002565b156103a8576103e4855b60408051808201825260008082526020918201528151808301909252825182529182019181019190915290565b9250600091505b85518210156104395760408051808201909152600181527f7c00000000000000000000000000000000000000000000000000000000000000602082015261044190610462906104e6906103b7565b505050505050565b90506105818683815181101561000257906020019060200201518286610296565b604080516020818101835260008083528351918201845280825284519351929391929091908059106104915750595b9080825280602002602001820160405280156104a8575b509150602082019050610965818560200151866000015160005b602082106109b757825184526020938401939290920191601f1991909101906104c2565b85906040805180820190915260008082526020820152610965838383604080518082019091526000808252602082810182905285518682015186519287015161096c93906000808080808887116109d557602087116109e75760018760200360080260020a031980875116888b038a018a96505b81838851161461057657600187019681901061055a578b8b0196505b5050508394506109db565b600191909101906103eb565b156103a8576000805473ffffffffffffffffffffffffffffffffffffffff1916821790556103a5565b156103a85781600160a060020a031663aa67735482306040518360e060020a0281526004018083600160a060020a0316815260200182600160a060020a03168152602001925050506000604051808303816000876161da5a03f115610002575050505b5050565b820191906000526020600020905b81548152906001019060200180831161062b57829003601f168201915b505050505081565b156103a85780600160a060020a0316632ec2c246306040518260e060020a0281526004018082600160a060020a031681526020019150506000604051808303816000876161da5a03f115610002575050506103a5565b156103a85781600160a060020a0316632ec2c246826040518260e060020a0281526004018082600160a060020a031681526020019150506000604051808303816000876161da5a03f11561000257505050610619565b156103a857600083815260036020908152604082208054855182855293839020919360026001831615610100026000190190921691909104601f90810184900483019391929187019083901061077557805160ff19168380011785555b506107a59291505b808211156108c05760008155600101610761565b82800160010185558215610759579182015b82811115610759578251826000505591602001919060010190610787565b50508080156108225750604080516002547f3560afd5000000000000000000000000000000000000000000000000000000008252600482018690529151600160a060020a039290921691633560afd59160248181019260209290919082900301816000876161da5a03f11561000257505060405151151560011490505b156108c45782600019167f7e8c916a2c8d9cc8d8e67f1028137812a6d636c5e1b1dc547a5ca0f9f415e1db8360405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156108ae5780820380516001836020036101000a031916815260200191505b509250505060405180910390a2610959565b5090565b82600019167ffbd6e799d0b7e94983ada5c7c8d53bf8897a567d5453ded6f059b25204bb58248360405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561094b5780820380516001836020036101000a031916815260200191505b509250505060405180910390a25b505050565b5060005b90565b5092915050565b6020868101805191860191909152805182038552865190519192500181141561099857600085526109ae565b8251845186519101900385528351810160208601525b50909392505050565b50905182516020929092036101000a60001901918216911916179052565b88880194505b50505050949350505050565b8686208894506000935091505b86890383116109d5575085832080821415610a11578394506109db565b60019384019392909201916109f456";
        private readonly Web3 web3;

        public WorkRegistryWorkByteCodeMatcher(Web3 web3)
        {
            this.web3 = web3;
        }

        public async Task<bool> IsMatchAsync(string address)
        {
            var code = await web3.Eth.GetCode.SendRequestAsync(web3.ToValid20ByteAddress(address));
            return code.IsTheSameHex(workByteCode); 
        }
    }
}